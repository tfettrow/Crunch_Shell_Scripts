	
subjects=(CrunchPilot02)
#subjects=(ClarkPilot_01 ClarkPilot_02)


#ants_processing_steps=("ants_create_MVT")
ants_processing_steps=("ants_registration_Func_2_MNI")
#ants_processing_steps=("ants_registration_Func_2_T1")
#ants_processing_steps=("ants_apply_transform")

# # # TO DO: 
# create option to run MVT and ANTSreg locally or batch
# what is a dilated segmentation??
# create an ANTS processing_fmri/dwi? .sh

for SUB in ${subjects[@]}; do
	if [[ ${preprocessing_steps[*]} =~ "ants_registration_Func_2_MNI" ]]; then
		data_folder_to_analyze=(05_MotorImagery)
		for DAT_Folder in ${data_folder_to_analyze[@]}; do

			Subject_dir=/ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/Pilot_Study_Data/${SUB}/

			# Create folders
			mkdir -p ${Subject_dir}/Processed/MRI_files/${DAT_Folder}/ANTS_Processing

			ml gcc/5.2.0
			ml ants
			
			outputFolder=${Subject_dir}/Processed/MRI_files/${DAT_Folder}/ANTS_Processing
			Mean_Func=/ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch/meanunwarpedRealigned_slicetimed_fMRI01Run1.nii
			MNI_Template=/ufrc/rachaelseidler/tfettrow/Crunch_Code/MR_Templates/_ANTs_c0cTemplate_T1_IXI555_MNI152_GS_brain.nii
			
			antsRegistration --dimensionality 3 --float 0 \
			        --output [$outputFolder/Func_to_MNI_,$outputFolder/Func_to_MNI_Warped.nii.gz] \
			        --interpolation Linear \
			        --winsorize-image-intensities [0.005,0.995] \
			        --use-histogram-matching 0 \
			        --initial-moving-transform [$Mean_Func,$MNI_Template,1] \
			        --transform Rigid[0.1] \
			        --metric MI[$Mean_Func,$MNI_Template,1,32,Regular,0.25] \
			        --convergence [1000x500x250x100,1e-6,10] \
			        --shrink-factors 8x4x2x1 \
			        --smoothing-sigmas 3x2x1x0vox \
			        --transform Affine[0.1] \
			        --metric MI[$Mean_Func,$MNI_Template,1,32,Regular,0.25] \
			        --convergence [1000x500x250x100,1e-6,10] \
			        --shrink-factors 8x4x2x1 \
			        --smoothing-sigmas 3x2x1x0vox \
			        --transform SyN[0.1,3,0] \
			        --metric CC[$Mean_Func,$MNI_Template,1,4] \
			        --convergence [100x70x50x20,1e-6,10] \
			        --shrink-factors 8x4x2x1 \
			        --smoothing-sigmas 3x2x1x0vox
		done
	fi
	if [[ ${preprocessing_steps[*]} =~ "ants_apply_transform" ]]; then
		data_folder_to_analyze=(05_MotorImagery)
		for DAT_Folder in ${data_folder_to_analyze[@]}; do

			cp /ufrc/rachaelseidler/tfettrow/Crunch_Code/MR_Templates/_ANTs_c0cTemplate_T1_IXI555_MNI152_GS_brain.nii /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch
			cp /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/Pilot_Study_Data/${SUB}/Processed/MRI_files/${DAT_Folder}/unwarpedRealigned_slicetimedMBtiming_fMRI01Run1.nii /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch
			cd /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch

			ml gcc/5.2.0; ml ants
			antsApplyTransforms -d 3 -e 3 -i unwarpedRealigned_slicetimed_fMRI01Run1.nii -r _ANTs_c0cTemplate_T1_IXI555_MNI152_GS_brain.nii \
			-n BSpline -o unwarpedRealigned_slicetimed_warpedToTemplate.nii.gz -t [Template_to_A_01_1InverseWarp.nii.gz] -t [Template_to_A_01_0GenericAffine.mat,1] -v 
			
			# TO DO:
			# Func -> T1 -> MVT -> MNI
			# create a flow field (concatenation of transformation matrices) using antsApplyTransforms
			# need to run registration multiple times 1) Func -> T1   2) T1 -> MNI   3) MVT -> MNI
			# use antsApplyTrasnforms to ...
			# shrink factors.. ?

			#antsApplyTransforms -d 3 -e 3 -i unwarpedRealigned_slicetimedMBtiming_fMRI01Run2.nii -r ANTs_c0Template_T1_IXI555_MNI152_GS_brain.nii \
			#-n BSpline -o unwarpedRealigned_slicetimed_warpedToTemplate.nii.gz -t [Template_to_unwarpedRealigned_slicetimed_1InverseWarp.nii.gz] -t [Template_to_unwarpedRealigned_slicetimed_0GenericAffine.mat,1] -v 
		done
	fi
done

if [[ ${preprocessing_steps[*]} =~ "ants_create_MVT" ]]; then
	for SUB in ${subjects[@]}; do
		# need to grab the biascorrected.nii from the subjects of interest
		# move them to the "processing folder" and change file name to include subjectID
		# move .batch to "processing folder" 


		mkdir -p /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch_Batch
		cd /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/Pilot_Study_Data/${SUB}/Processed/MRI_files/02_T1/
		cp SkullStripped_biascorrected.nii /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch_Batch
		
		cd /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch_Batch
		mv -v SkullStripped_biascorrected.nii "${SUB}_SkullStripped_biascorrected.nii"
	done
	cd /ufrc/rachaelseidler/tfettrow/Crunch_Code/Shell_Scripts
	cp run_ANTS.batch /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch_Batch
	cd /ufrc/rachaelseidler/share/FromExternal/Research_Projects_UF/CRUNCH/ANTS_Template_Processing_Folder_Crunch_Batch
	sbatch run_ANTS.batch
	#rm run_ANTS_MVT.batch
fi
